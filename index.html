<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agenda & Intervall-Timer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://unpkg.com" />
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    .ring-bg { stroke-opacity: .15 }
    .time-shadow { text-shadow: 0 1px 0 rgba(0,0,0,.04); }
    /* Viktig: ingen hardkodet hvit bakgrunn, fargen styres fra SceneView */
    .scene-backdrop { position: fixed; inset: 0; z-index: 50; }
  </style>
</head>
<body class="bg-neutral-50">
  <div id="root"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useRef, useState } = React;

    /* ---- Hjelpefunksjoner ---- */
    function uuid() {
      if (window.crypto && crypto.randomUUID) return crypto.randomUUID();
      return 'id-' + Math.random().toString(36).slice(2) + Date.now();
    }
    function formatClock(totalSeconds) {
      const s = Math.max(0, Math.round(totalSeconds || 0));
      const mm = String(Math.floor(s / 60)).padStart(2, '0');
      const ss = String(s % 60).padStart(2, '0');
      return `${mm}:${ss}`;
    }
    function clampNum(v, min, max) {
      const n = Math.max(min, Math.floor(Number(v) || 0));
      return typeof max === 'number' ? Math.min(n, max) : n;
    }
    const audioCtxRefGlobal = { current: null };
    function ensureAudio() {
      try {
        if (!audioCtxRefGlobal.current) {
          const Ctx = window.AudioContext || window.webkitAudioContext;
          audioCtxRefGlobal.current = new Ctx();
        }
        return audioCtxRefGlobal.current;
      } catch { return null; }
    }
    function beep(freq = 440, duration = 120, volume = 0.7) {
      try {
        const ctx = ensureAudio(); if (!ctx) return;
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'sine'; o.frequency.value = freq;
        g.gain.value = volume; o.connect(g); g.connect(ctx.destination);
        o.start();
        setTimeout(() => { o.stop(); g.disconnect(); }, duration);
      } catch {}
    }
    function vibrate(pattern) { try { if (navigator.vibrate) navigator.vibrate(pattern); } catch {} }
    function toSeconds(it) { return (Number(it?.minutes)||0)*60 + (Number(it?.seconds)||0); }

    /* ---- App ---- */
    function App() {
      // Flere agendaer
      const [agendas, setAgendas] = useState(() => {
        try {
          const saved = JSON.parse(localStorage.getItem('ait-agendas')||'null');
          if (Array.isArray(saved) && saved.length) return saved;
        } catch {}
        let legacyItems = null;
        try { legacyItems = JSON.parse(localStorage.getItem('ait-items')||'null'); } catch {}
        return [{
          id: uuid(),
          name: 'Min agenda',
          meetingMode: false,
          startTime: '',
          items: legacyItems && legacyItems.length ? legacyItems : [
            { id: uuid(), label: 'Oppstart',    minutes: 0, seconds: 30, color: '#fde68a' },
            { id: uuid(), label: 'Sak 1',       minutes: 0, seconds: 45, color: '#bbf7d0' },
            { id: uuid(), label: 'Pause',       minutes: 0, seconds: 15, color: '#bfdbfe' },
            { id: uuid(), label: 'Evaluering',  minutes: 0, seconds: 30, color: '#fca5a5' },
          ]
        }];
      });
      const [activeAgendaId, setActiveAgendaId] = useState(() => agendas[0]?.id);

      const active = useMemo(() => agendas.find(a => a.id === activeAgendaId) || agendas[0], [agendas, activeAgendaId]);
      const [items, setItems] = useState(active?.items || []);
      const [meetingMode, setMeetingMode] = useState(!!active?.meetingMode);
      const [startTime, setStartTime] = useState(active?.startTime || '');

      useEffect(() => {
        setItems(active?.items || []);
        setMeetingMode(!!active?.meetingMode);
        setStartTime(active?.startTime || '');
        setCurrentIdx(0);
      }, [activeAgendaId]);

      function saveAgendas(nextAgendas) {
        setAgendas(nextAgendas);
        try { localStorage.setItem('ait-agendas', JSON.stringify(nextAgendas)); } catch {}
      }
      useEffect(() => {
        const next = agendas.map(a => a.id === activeAgendaId ? { ...a, items, meetingMode, startTime } : a);
        saveAgendas(next);
        try { localStorage.setItem('ait-items', JSON.stringify(items)); } catch {}
      }, [items, meetingMode, startTime]);

      // Timer
      const [currentIdx, setCurrentIdx] = useState(0);
      const [remaining, setRemaining] = useState(() => toSeconds((active?.items||[])[0]));
      const [running, setRunning] = useState(false);
      const [volume, setVolume] = useState(0.7);
      const [vibrateOn, setVibrateOn] = useState(true);
      const [muted, setMuted] = useState(false);
      const [scene, setScene] = useState(false);

      const deadlineRef = useRef(null);
      const advancingRef = useRef(false);

      function startBlockForIndex(idx) {
        const dur = toSeconds(items[idx] || { minutes:0, seconds:0 });
        const now = performance.now();
        deadlineRef.current = now + dur * 1000;
        setRemaining(dur);
        advancingRef.current = false;
      }
      useEffect(() => { startBlockForIndex(currentIdx); }, [currentIdx, items]);

      useEffect(() => {
        if (!running) return;
        let raf;
        const loop = () => {
          const now = performance.now();
          const msLeft = Math.max(0, (deadlineRef.current ?? now) - now);
          const nextRem = msLeft / 1000;
          setRemaining(nextRem);
          if (nextRem === 0 && !advancingRef.current) {
            advancingRef.current = true;
            if (!muted && volume > 0) beep(440, 140, volume);
            if (vibrateOn) vibrate([120,60,120]);
            setTimeout(() => setCurrentIdx(i => Math.min(items.length - 1, i + 1)), 0);
          }
          raf = requestAnimationFrame(loop);
        };
        raf = requestAnimationFrame(loop);
        return () => cancelAnimationFrame(raf);
      }, [running, volume, vibrateOn, muted, items.length]);

      function start()  { const now = performance.now(); deadlineRef.current = now + Math.max(0, remaining) * 1000; advancingRef.current = false; setRunning(true); }
      function pause()  { setRunning(false); }
      function reset()  { setRunning(false); setCurrentIdx(0); startBlockForIndex(0); }
      function nextItem(){ setCurrentIdx(i => Math.min(items.length - 1, i + 1)); }
      function prevItem(){ setCurrentIdx(i => Math.max(0, i - 1)); }

      const totalSeconds = useMemo(() => items.reduce((s, it) => s + toSeconds(it), 0), [items]);
      const elapsedSeconds = useMemo(() => {
        const before = items.slice(0, currentIdx).reduce((s, it) => s + toSeconds(it), 0);
        return before + (toSeconds(items[currentIdx]) - remaining);
      }, [items, currentIdx, remaining]);

      const currentDur = toSeconds(items[currentIdx] || {minutes:0,seconds:0});
      const progress = currentDur > 0 ? (currentDur - remaining) / currentDur : 0;
      const r = 56; const C = 2 * Math.PI * r;
      const dash = Math.max(0, Math.min(1, progress));

      function plannedStartForIndex(idx) {
        if (!meetingMode || !startTime) return null;
        const [h, m] = startTime.split(':').map(Number);
        const base = new Date(); base.setHours(h||0, m||0, 0, 0);
        let offset = 0; for (let i=0;i<idx;i++) offset += toSeconds(items[i]);
        const d = new Date(base.getTime() + offset * 1000);
        return d.toTimeString().slice(0,5);
      }

      // Agendahåndtering
      function newAgenda() {
        const name = prompt('Navn på ny agenda?', 'Ny agenda');
        if (!name) return;
        const a = { id: uuid(), name, meetingMode: false, startTime: '', items: [] };
        const next = [...agendas, a]; saveAgendas(next); setActiveAgendaId(a.id);
      }
      function renameAgenda() {
        const name = prompt('Nytt navn for agenda:', active?.name || '');
        if (!name) return;
        saveAgendas(agendas.map(a => a.id === activeAgendaId ? { ...a, name } : a));
      }
      function saveAsAgenda() {
        const name = prompt('Lagre som… Navn på kopi:', (active?.name || 'Agenda') + ' (kopi)');
        if (!name) return;
        const a = { id: uuid(), name, meetingMode, startTime, items };
        const next = [...agendas, a]; saveAgendas(next); setActiveAgendaId(a.id);
      }
      function deleteAgenda() {
        if (!active) return;
        if (!confirm(`Slette "${active.name}"?`)) return;
        const next = agendas.filter(a => a.id !== activeAgendaId);
        if (!next.length) {
          const fresh = { id: uuid(), name: 'Ny agenda', meetingMode: false, startTime: '', items: [] };
          saveAgendas([fresh]); setActiveAgendaId(fresh.id);
        } else {
          saveAgendas(next); setActiveAgendaId(next[0].id);
        }
      }
      function exportAll() {
        const blob = new Blob([JSON.stringify(agendas, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `agendebok_${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(url);
      }
      function importAll(evt) {
        const file = evt.target.files?.[0]; if (!file) return;
        const reader = new FileReader(); reader.onload = () => {
          try {
            const data = JSON.parse(String(reader.result));
            if (Array.isArray(data) && data.length) { saveAgendas(data); setActiveAgendaId(data[0].id); }
            else alert('Filen inneholder ikke en gyldig agendebok');
          } catch { alert('Kunne ikke lese filen'); }
        }; reader.readAsText(file);
      }

      /* ---- Scene-modus ---- */
      function SceneView() {
        const bg = items[currentIdx]?.color || '#ffffff';
        return (
          <div className="scene-backdrop p-6" style={{ background: bg }}>
            <div className="max-w-6xl mx-auto h-full grid place-items-center">
              <div className="w-full grid md:grid-cols-3 gap-6 items-center">
                <div className="md:col-span-2 p-6 rounded-2xl shadow bg-white/90 flex items-center justify-between">
                  <div>
                    <div className="text-sm uppercase tracking-wide text-neutral-600">Nå</div>
                    <div className="text-4xl md:text-6xl font-semibold">{items[currentIdx]?.label || '—'}</div>
                    {meetingMode && startTime && (
                      <div className="text-lg text-neutral-700">Planlagt start: {plannedStartForIndex(currentIdx) || '—'}</div>
                    )}
                  </div>
                  <div className="relative flex items-center justify-center w-40 h-40 md:w-60 md:h-60">
                    <svg viewBox="0 0 240 240" className="block w-full h-full">
                      {(() => { const R=96, CC=2*Math.PI*R; return (
                        <>
                          <circle cx="120" cy="120" r={R} stroke="currentColor" className="ring-bg" strokeWidth="14" fill="none"/>
                          <circle cx="120" cy="120" r={R} stroke="currentColor" strokeWidth="14" fill="none"
                            strokeLinecap="round"
                            style={{ transform:'rotate(-90deg)', transformOrigin:'50% 50%', strokeDasharray: CC, strokeDashoffset: CC*(1-dash) }} />
                        </>
                      ); })()}
                    </svg>
                    <div className="absolute inset-0 flex items-center justify-center">
                      <div className="text-5xl md:text-7xl font-mono tabular-nums time-shadow">{formatClock(remaining)}</div>
                    </div>
                  </div>
                </div>
                <div className="p-6 rounded-2xl shadow bg-white/90 flex flex-col gap-3 justify-between">
                  <div>
                    <div className="text-sm uppercase tracking-wide text-neutral-600">Neste</div>
                    <div className="text-2xl font-medium">{items[currentIdx+1]?.label || '—'}</div>
                  </div>
                  <div className="grid grid-cols-2 gap-2">
                    {!running ? (
                      <button onClick={start} className="w-full md:w-auto px-4 py-3 rounded-2xl bg-green-600 text-white shadow hover:opacity-90">Start</button>
                    ) : (
                      <button onClick={pause} className="w-full md:w-auto px-4 py-3 rounded-2xl bg-yellow-500 text-white shadow hover:opacity-90">Pause</button>
                    )}
                    <button onClick={nextItem} className="w-full md:w-auto px-4 py-3 rounded-2xl bg-neutral-200 hover:bg-neutral-300">Neste</button>
                    <button onClick={prevItem} className="w-full md:w-auto px-4 py-3 rounded-2xl bg-neutral-200 hover:bg-neutral-300">Forrige</button>
                    <button onClick={reset} className="w-full md:w-auto px-4 py-3 rounded-2xl bg-neutral-800 text-white">Nullstill</button>
                  </div>
                  <button onClick={()=>setScene(false)} className="px-3 py-2 rounded-xl bg-neutral-100">Lukk scene-modus</button>
                </div>
              </div>
            </div>
          </div>
        );
      }

      /* ---- UI ---- */
      return (
        <div className="min-h-screen text-neutral-900 p-6">
          {scene && <SceneView/>}

          <div className="max-w-5xl mx-auto grid gap-6">
            {/* Topp: velg/administrer agenda */}
            <div className="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
              <div className="flex flex-wrap items-center gap-2">
                <label className="text-sm">Agenda:</label>
                <select className="border rounded px-2 py-1" value={activeAgendaId} onChange={e=>setActiveAgendaId(e.target.value)}>
                  {agendas.map(a => <option key={a.id} value={a.id}>{a.name}</option>)}
                </select>
                <button onClick={newAgenda} className="px-2 py-1 rounded bg-neutral-200">Ny</button>
                <button onClick={renameAgenda} className="px-2 py-1 rounded bg-neutral-200">Gi nytt navn</button>
                <button onClick={saveAsAgenda} className="px-2 py-1 rounded bg-neutral-200">Lagre som</button>
                <button onClick={deleteAgenda} className="px-2 py-1 rounded bg-red-500 text-white">Slett</button>
              </div>
              <div className="flex flex-wrap items-center gap-2">
                <button onClick={exportAll} className="px-2 py-1 rounded bg-neutral-900 text-white">Eksporter alle</button>
                <label className="px-2 py-1 rounded bg-neutral-200 cursor-pointer">Importer alle
                  <input type="file" accept="application/json" className="hidden" onChange={importAll} />
                </label>
              </div>
            </div>

            {/* Nå-kort */}
            <div className="grid gap-4 sm:grid-cols-3">
              <div className="sm:col-span-2 p-5 rounded-2xl shadow bg-white flex items-center justify-between" style={{background: (items[currentIdx]?.color || 'white')}}>
                <div>
                  <div className="text-sm uppercase tracking-wide text-neutral-600">Nå</div>
                  <div className="text-2xl sm:text-4xl font-semibold">{items[currentIdx]?.label || '—'}</div>
                  {meetingMode && startTime && (
                    <div className="text-sm text-neutral-700">Planlagt start: {plannedStartForIndex(currentIdx) || '—'}</div>
                  )}
                </div>
                <div className="relative flex items-center justify-center w-28 h-28 sm:w-36 sm:h-36">
                  <svg viewBox="0 0 140 140" className="block w-full h-full">
                    <circle cx="70" cy="70" r={56} stroke="currentColor" className="ring-bg" strokeWidth="10" fill="none"/>
                    <circle cx="70" cy="70" r={56} stroke="currentColor" strokeWidth="10" fill="none"
                      strokeLinecap="round"
                      style={{ transform: 'rotate(-90deg)', transformOrigin: '50% 50%', strokeDasharray: 2*Math.PI*56, strokeDashoffset: (2*Math.PI*56) * (1 - Math.max(0, Math.min(1, (currentDur>0 ? (currentDur-remaining)/currentDur : 0)))) }}
                    />
                  </svg>
                  <div className="absolute inset-0 flex items-center justify-center">
                    <div className="text-3xl sm:text-4xl font-mono tabular-nums time-shadow">{formatClock(remaining)}</div>
                  </div>
                </div>
              </div>

              <div className="p-5 rounded-2xl shadow bg-white flex flex-col justify-between">
                <div>
                  <div className="text-sm uppercase tracking-wide text-neutral-600">Neste</div>
                  <div className="text-lg font-medium">{items[currentIdx+1]?.label || '—'}</div>
                </div>
                <div className="text-sm text-neutral-700">
                  Totalt: {formatClock(totalSeconds)}<br/>Gått: {formatClock(elapsedSeconds)}
                </div>
              </div>
            </div>

            {/* Kontroller */}
            <div className="grid grid-cols-2 gap-2 md:flex md:flex-wrap md:items-center md:gap-3">
              {!running ? (
                <button onClick={start} className="w-full md:w-auto px-4 py-2 rounded-2xl bg-green-600 text-white shadow hover:opacity-90">Start</button>
              ) : (
                <button onClick={pause} className="w-full md:w-auto px-4 py-2 rounded-2xl bg-yellow-500 text-white shadow hover:opacity-90">Pause</button>
              )}
              <button onClick={prevItem} className="w-full md:w-auto px-4 py-2 rounded-2xl bg-neutral-200 hover:bg-neutral-300">Forrige</button>
              <button onClick={nextItem} className="w-full md:w-auto px-4 py-2 rounded-2xl bg-neutral-200 hover:bg-neutral-300">Neste</button>
              <button onClick={reset} className="w-full md:w-auto px-4 py-2 rounded-2xl bg-neutral-800 text-white">Nullstill</button>
            </div>

            {/* Editor */}
            <div className="grid gap-3">
              <div className="flex justify-between items-center">
                <h2 className="text-lg font-semibold">Blokker</h2>
                <button onClick={() => setItems(it => [...it, { id: uuid(), label: `Sak ${it.length + 1}`, minutes: 0, seconds: 30, color: '#e5e7eb' }])} className="px-3 py-1.5 rounded-xl bg-neutral-900 text-white">Legg til blokk</button>
              </div>
              <div className="grid gap-2">
                {items.map((it, idx) => (
                  <div key={it.id} className="grid grid-cols-1 md:grid-cols-12 gap-3 md:gap-2 items-center p-3 rounded-xl bg-white shadow">
                    <div className="col-span-12 md:col-span-3 w-full">
                      <input className="w-full border rounded px-2 py-1" value={it.label} onChange={e=>setItems(list=>list.map(x=>x.id===it.id?{...x,label:e.target.value}:x))} />
                    </div>
                    <div className="col-span-12 md:col-span-3 flex flex-wrap items-center gap-2">
                      <label className="text-sm">Min</label>
                      <input type="number" min={0} className="w-14 md:w-16 border rounded px-2 py-1" value={it.minutes} onChange={e=>setItems(list=>list.map(x=>x.id===it.id?{...x,minutes:clampNum(e.target.value,0,999)}:x))} />
                      <label className="text-sm">Sek</label>
                      <input type="number" min={0} max={59} className="w-14 md:w-16 border rounded px-2 py-1" value={it.seconds} onChange={e=>setItems(list=>list.map(x=>x.id===it.id?{...x,seconds:clampNum(e.target.value,0,59)}:x))} />
                    </div>
                    <div className="col-span-12 md:col-span-3 flex flex-wrap items-center gap-2">
                      <label className="text-sm">Farge</label>
                      <input type="color" className="h-8 w-8" value={it.color} onChange={e=>setItems(list=>list.map(x=>x.id===it.id?{...x,color:e.target.value}:x))} />
                      {meetingMode && (<span className="text-xs text-neutral-600">Start: {plannedStartForIndex(idx) || '—'}</span>)}
                    </div>
                    <div className="col-span-12 md:col-span-3 flex flex-wrap items-center justify-start md:justify-end gap-2">
                      <button onClick={()=>setItems(list=>{const i=list.findIndex(x=>x.id===it.id); if(i<=0)return list; const copy=[...list]; const [sp]=copy.splice(i,1); copy.splice(i-1,0,sp); return copy;})} className="px-2 py-1 rounded bg-neutral-200">↑</button>
                      <button onClick={()=>setItems(list=>{const i=list.findIndex(x=>x.id===it.id); if(i<0||i>=list.length-1)return list; const copy=[...list]; const [sp]=copy.splice(i,1); copy.splice(i+1,0,sp); return copy;})} className="px-2 py-1 rounded bg-neutral-200">↓</button>
                      <button onClick={()=>setItems(list=>list.filter(x=>x.id!==it.id))} className="px-2 py-1 rounded bg-red-500 text-white">Slett</button>
                    </div>
                  </div>
                ))}
              </div>
            </div>

            <footer className="text-xs text-neutral-600 pt-1 hidden sm:block">
              Tips: Slå på Møte-modus for beregnede klokkeslett. Lyd/vibrasjon krever først et klikk og støttes ikke på alle telefoner (iOS kan begrense vibrasjon i nettleser). Alle agendaer lagres lokalt i nettleseren din.
            </footer>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App/>);
  </script>
</body>
</html>
